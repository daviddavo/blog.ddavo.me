<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Using ROS2 in Coppelia | David Davó</title>
<meta name=keywords content="Coppelia,lidar,PointCloud,ros2,V-REP,SLAM toolbox"><meta name=description content="With this tutorial you will learn how to use ROS2 in the Coppelia simulator (formerly V-REP) with the simExtROS2 library, using the lidar to build a map."><meta name=author content><link rel=canonical href=https://blog.ddavo.me/posts/tutorials/ros2-coppelia-lidar/><link crossorigin=anonymous href=/assets/css/stylesheet.min.5dea304099e1fd8e1ed53c45aa7df386b96fb775ca4cde2899bc98a14fa51ed4.css integrity="sha256-XeowQJnh/Y4e1TxFqn3zhrlvt3XKTN4ombyYoU+lHtQ=" rel="preload stylesheet" as=style><link rel=icon href=https://blog.ddavo.me/favicon.ico><link rel=apple-touch-icon href=https://blog.ddavo.me/apple-touch-icon.png><link rel=alternate hreflang=en href=https://blog.ddavo.me/posts/tutorials/ros2-coppelia-lidar/><meta name=twitter:title content="Using ROS2 in Coppelia | David Davó"><meta name=twitter:description content="With this tutorial you will learn how to use ROS2 in the Coppelia simulator (formerly V-REP) with the simExtROS2 library, using the lidar to build a map."><meta property="og:title" content="Using ROS2 in Coppelia | David Davó"><meta property="og:description" content="With this tutorial you will learn how to use ROS2 in the Coppelia simulator (formerly V-REP) with the simExtROS2 library, using the lidar to build a map."><meta property="og:type" content="article"><meta property="og:url" content="https://blog.ddavo.me/posts/tutorials/ros2-coppelia-lidar/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-01-31T20:08:41+00:00"><meta property="article:modified_time" content="2024-08-04T18:17:00+00:00"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://blog.ddavo.me/posts/"},{"@type":"ListItem","position":2,"name":"Using ROS2 in Coppelia","item":"https://blog.ddavo.me/posts/tutorials/ros2-coppelia-lidar/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Using ROS2 in Coppelia | David Davó","name":"Using ROS2 in Coppelia","description":"With this tutorial you will learn how to use ROS2 in the Coppelia simulator (formerly V-REP) with the simExtROS2 library, using the lidar to build a map.","keywords":["Coppelia","lidar","PointCloud","ros2","V-REP","SLAM toolbox"],"wordCount":"1606","inLanguage":"en","datePublished":"2023-01-31T20:08:41.804Z","dateModified":"2024-08-04T18:17:00.617Z","mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.ddavo.me/posts/tutorials/ros2-coppelia-lidar/"},"publisher":{"@type":"Organization","name":"David Davó's dev log","logo":{"@type":"ImageObject","url":"https://blog.ddavo.me/favicon.ico"}}}</script><script>var _paq=window._paq=window._paq||[];_paq.push(["trackPageView"]),_paq.push(["enableLinkTracking"]),function(){e="//matomo.ddavo.me/",_paq.push(["setTrackerUrl",e+"matomo.php"]),_paq.push(["setSiteId","4"]);var e,n=document,t=n.createElement("script"),s=n.getElementsByTagName("script")[0];t.async=!0,t.src=e+"matomo.js",s.parentNode.insertBefore(t,s)}()</script><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary-bg:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list-page{background:var(--theme)}.list-page:not(.dark)::-webkit-scrollbar-track{background:0 0}.list-page:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript></head><body class="type-default kind-page layout-" id=top><script data-no-instant>function switchTheme(e){switch(e){case"light":document.body.classList.remove("dark");break;case"dark":document.body.classList.add("dark");break;default:window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")}}function isDarkTheme(){return document.body.className.includes("dark")}function getPrefTheme(){return localStorage.getItem("pref-theme")}function setPrefTheme(e){switchTheme(e),localStorage.setItem("pref-theme",e)}const toggleThemeCallbacks={};toggleThemeCallbacks.main=e=>{setPrefTheme(e?"light":"dark")},window.addEventListener("toggle-theme",function(){const e=isDarkTheme();for(const t in toggleThemeCallbacks)toggleThemeCallbacks[t](e)});function toggleThemeListener(){window.dispatchEvent(new CustomEvent("toggle-theme"))}</script><script>(function(){const t="light",e=getPrefTheme(),n=e||t;switchTheme(n)})()</script><header class=header><nav class=nav><div class=logo><a href=https://blog.ddavo.me/ accesskey=h title="David Davó's dev log (Alt + H)">David Davó's dev log</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button><ul class=lang-switch><li>|</li><li><a href=https://blog.ddavo.me/es/ title="🇪🇸 Español" aria-label=":es: Español">🇪🇸 Español</a></li></ul></span></div><ul id=menu></ul></nav></header><main class="main post"><article class=post-single><header class=post-header><h1 class=post-title>Using ROS2 in Coppelia</h1><div class=post-description>With this tutorial you will learn how to use ROS2 in the Coppelia simulator (formerly V-REP) with the simExtROS2 library, using the lidar to build a map.</div><div class=post-meta><span class=meta-item><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar" style="user-select:text"><rect x="3" y="4" width="18" height="18" rx="2" ry="2" style="user-select:text"/><line x1="16" y1="2" x2="16" y2="6" style="user-select:text"/><line x1="8" y1="2" x2="8" y2="6" style="user-select:text"/><line x1="3" y1="10" x2="21" y2="10" style="user-select:text"/></svg>
<span>2023-01-31</span></span><span class=meta-item>
<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon" style="user-select:text"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z" style="user-select:text"/><line x1="7" y1="7" x2="7" y2="7" style="user-select:text"/></svg>
<span class=post-tags><a href=https://blog.ddavo.me/tags/tutorial/>Tutorial</a><a href=https://blog.ddavo.me/tags/ros2/>ROS2</a><a href=https://blog.ddavo.me/tags/coppelia/>Coppelia</a><a href=https://blog.ddavo.me/tags/robotics/>Robotics</a></span></span><span class=meta-item>
<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text" style="user-select:text"><path d="M14 2H6A2 2 0 004 4v16a2 2 0 002 2h12a2 2 0 002-2V8z" style="user-select:text"/><polyline points="14 2 14 8 20 8" style="user-select:text"/><line x1="16" y1="13" x2="8" y2="13" style="user-select:text"/><line x1="16" y1="17" x2="8" y2="17" style="user-select:text"/><polyline points="10 9 9 9 8 9" style="user-select:text"/></svg>
<span>1606 words</span></span><span class=meta-item>
<svg width="24" height="24" viewBox="0 0 24 24" stroke="currentcolor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<span>8 min</span></span></div></header><div class="toc side left"><details open><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#introduction aria-label=Introduction>Introduction</a></li><li><a href=#installing-simextros2 aria-label="Installing simExtROS2">Installing simExtROS2</a><ul><li><a href=#compiling-libsimextros2 aria-label="Compiling libsimExtROS2">Compiling libsimExtROS2</a></li></ul></li><li><a href=#modifications-in-coppelia aria-label="Modifications in Coppelia">Modifications in Coppelia</a><ul><li><a href=#publishing-the-simulation-time aria-label="Publishing the simulation time">Publishing the simulation time</a></li><li><a href=#publishing-transforms aria-label="Publishing transforms">Publishing transforms</a></li><li><a href=#publishing-lidar-pointcloud aria-label="Publishing Lidar PointCloud">Publishing Lidar PointCloud</a></li><li><a href=#setting-the-robots-speed aria-label="Setting the robot&amp;rsquo;s speed">Setting the robot&rsquo;s speed</a></li></ul></li><li><a href=#ros2 aria-label=ROS2>ROS2</a><ul><li><a href=#running-the-nodes aria-label="Running the nodes">Running the nodes</a></li></ul></li><li><a href=#conclusion aria-label=Conclusion>Conclusion</a></li><li><a href=#sources-and-more-information aria-label="Sources and more information">Sources and more information</a></li></ul></div></details></div><div class=post-content><h2 id=introduction>Introduction<a hidden class=anchor aria-hidden=true href=#introduction>¶</a></h2><p>Let&rsquo;s be honest, if you&rsquo;re here it&rsquo;s probably because you found this blog on Google.
As I understand it, at the moment there are no comprehensible resources to use
ROS2 with the Coppelia simulator (previously known as V-REP), and it is no simple task.</p><p>In this tutorial, we will make a simple project using a Pioneer P3DX with a Lidar, in which we
will use <em>Slam Toolbox</em> to create a map of the room, all using ROS2 tools like RVIZ2
and NAV2&rsquo;s Slam Toolbox, but using Coppelia as a simulator instead of Gazebo.</p><p>The end product will look something like this:</p><div style=position:relative;padding-bottom:56.25%;height:0;overflow:hidden><div style=width:100%;position:relative;padding-bottom:56.15%;height:0;overflow:hidden><iframe style=position:absolute;top:0;left:0;width:100%;height:100%;border:0 loading=lazy ; srcdoc="<style>
      * {
      padding: 0;
      margin: 0;
      overflow: hidden;
      }
      body, html {
        height: 100%;
      }
      img, svg {
        position: absolute;
        width: 100%;
        top: 0;
        bottom: 0;
        margin: auto;
      }
      svg {
        filter: drop-shadow(1px 1px 10px hsl(206.5, 70.7%, 8%));
        transition: all 250ms ease-in-out;
      }
      body:hover svg {
        filter: drop-shadow(1px 1px 10px hsl(206.5, 0%, 10%));
        transform: scale(1.2);
      }
    </style>
    <a href='https://www.youtube.com/embed/SYblPjsOgAM?autoplay=1'>
      <img src='https://img.youtube.com/vi/SYblPjsOgAM/hqdefault.jpg' alt='YouTube Video'>
      <svg xmlns='http://www.w3.org/2000/svg' width='64' height='64' viewBox='0 0 24 24' fill='none' stroke='#ffffff' stroke-width='2' stroke-linecap='round' stroke-linejoin='round' class='feather feather-play-circle'><circle cx='12' cy='12' r='10'></circle><polygon points='10 8 16 12 10 16 10 8'></polygon></svg>
    </a>
    " src=https://www.youtube.com/embed/SYblPjsOgAM title="YouTube Video" frameborder=0 allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe></div></div><p>I made it work but I&rsquo;m no expert in robotics, so if I made some error, please let
me know in the comments or <a href=https://github.com/daviddavo/blog.ddavo.me>on GitHub</a>.</p><p>I will center on the programming part because the way of adding a robot and lidar is the same whether you&rsquo;re using ROS2 or not.</p><blockquote><p>The original project was made as homework for the Master Universitario en Inteligencia Articial (MUIA) at Universidad Politécnica de Madrid (UPM)</p></blockquote><h2 id=installing-simextros2>Installing simExtROS2<a hidden class=anchor aria-hidden=true href=#installing-simextros2>¶</a></h2><p>ROS2 works by creating publishers and subscribers that emit and receive messages of a <em>message type</em>. To be able to do this from Coppelia, we will use the module <a href=https://github.com/CoppeliaRobotics/simExtROS2>simExtROS2</a>.</p><p>Coppelia comes with this module installed, but it&rsquo;s compiled with too few message types embedded.
If you try publishing some sensor data, it will fail. You need to modify a config file from the source code and
compile it again so it supports that message type.</p><p>First, we will download the source code. Because I&rsquo;m using Coppelia 4.4.0, I&rsquo;ll checkout to that version too. Feel free to change the version number if you need to.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>git clone --recursive https://github.com/CoppeliaRobotics/simExtROS2.git
</span></span><span class=line><span class=cl><span class=c1># according to the docs, we have to rename the folder</span>
</span></span><span class=line><span class=cl>mv simExtROS2 sim_ros2_interface
</span></span><span class=line><span class=cl>git checkout coppeliasim-v4.4.0-rev0
</span></span></code></pre></div><p>Before compiling, we need to modify a config file to specify the message types you want to compile. This file is <code>meta/interfaces.txt</code>, and in my case, it ended up with the following contents:</p><p><details><summary markdown=span><code>meta/interfaces.txt</code></summary><div class=highlight><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=n>builtin_interfaces</span><span class=o>/</span><span class=n>msg</span><span class=o>/</span><span class=n>Duration</span>
</span></span><span class=line><span class=cl><span class=n>builtin_interfaces</span><span class=o>/</span><span class=n>msg</span><span class=o>/</span><span class=n>Time</span>
</span></span><span class=line><span class=cl><span class=n>rosgraph_msgs</span><span class=o>/</span><span class=n>msg</span><span class=o>/</span><span class=n>Clock</span>
</span></span><span class=line><span class=cl><span class=n>geometry_msgs</span><span class=o>/</span><span class=n>msg</span><span class=o>/</span><span class=n>Quaternion</span>
</span></span><span class=line><span class=cl><span class=n>geometry_msgs</span><span class=o>/</span><span class=n>msg</span><span class=o>/</span><span class=ne>Transform</span>
</span></span><span class=line><span class=cl><span class=n>geometry_msgs</span><span class=o>/</span><span class=n>msg</span><span class=o>/</span><span class=n>TransformStamped</span>
</span></span><span class=line><span class=cl><span class=n>geometry_msgs</span><span class=o>/</span><span class=n>msg</span><span class=o>/</span><span class=ne>Vector3</span>
</span></span><span class=line><span class=cl><span class=n>geometry_msgs</span><span class=o>/</span><span class=n>msg</span><span class=o>/</span><span class=n>Point</span>
</span></span><span class=line><span class=cl><span class=n>geometry_msgs</span><span class=o>/</span><span class=n>msg</span><span class=o>/</span><span class=n>Pose</span>
</span></span><span class=line><span class=cl><span class=n>geometry_msgs</span><span class=o>/</span><span class=n>msg</span><span class=o>/</span><span class=n>PoseStamped</span>
</span></span><span class=line><span class=cl><span class=n>geometry_msgs</span><span class=o>/</span><span class=n>msg</span><span class=o>/</span><span class=n>Twist</span>
</span></span><span class=line><span class=cl><span class=n>geometry_msgs</span><span class=o>/</span><span class=n>msg</span><span class=o>/</span><span class=n>PoseWithCovariance</span>
</span></span><span class=line><span class=cl><span class=n>geometry_msgs</span><span class=o>/</span><span class=n>msg</span><span class=o>/</span><span class=n>TwistWithCovariance</span>
</span></span><span class=line><span class=cl><span class=n>sensor_msgs</span><span class=o>/</span><span class=n>msg</span><span class=o>/</span><span class=ne>Image</span>
</span></span><span class=line><span class=cl><span class=n>sensor_msgs</span><span class=o>/</span><span class=n>msg</span><span class=o>/</span><span class=n>PointCloud2</span>
</span></span><span class=line><span class=cl><span class=n>sensor_msgs</span><span class=o>/</span><span class=n>msg</span><span class=o>/</span><span class=n>PointField</span>
</span></span><span class=line><span class=cl><span class=n>sensor_msgs</span><span class=o>/</span><span class=n>msg</span><span class=o>/</span><span class=n>LaserScan</span>
</span></span><span class=line><span class=cl><span class=n>std_msgs</span><span class=o>/</span><span class=n>msg</span><span class=o>/</span><span class=n>Bool</span>
</span></span><span class=line><span class=cl><span class=n>std_msgs</span><span class=o>/</span><span class=n>msg</span><span class=o>/</span><span class=n>Byte</span>
</span></span><span class=line><span class=cl><span class=n>std_msgs</span><span class=o>/</span><span class=n>msg</span><span class=o>/</span><span class=n>ColorRGBA</span>
</span></span><span class=line><span class=cl><span class=n>std_msgs</span><span class=o>/</span><span class=n>msg</span><span class=o>/</span><span class=n>Empty</span>
</span></span><span class=line><span class=cl><span class=n>std_msgs</span><span class=o>/</span><span class=n>msg</span><span class=o>/</span><span class=n>Float32</span>
</span></span><span class=line><span class=cl><span class=n>std_msgs</span><span class=o>/</span><span class=n>msg</span><span class=o>/</span><span class=n>Float64</span>
</span></span><span class=line><span class=cl><span class=n>std_msgs</span><span class=o>/</span><span class=n>msg</span><span class=o>/</span><span class=n>Header</span>
</span></span><span class=line><span class=cl><span class=n>std_msgs</span><span class=o>/</span><span class=n>msg</span><span class=o>/</span><span class=n>Int8</span>
</span></span><span class=line><span class=cl><span class=n>std_msgs</span><span class=o>/</span><span class=n>msg</span><span class=o>/</span><span class=n>Int16</span>
</span></span><span class=line><span class=cl><span class=n>std_msgs</span><span class=o>/</span><span class=n>msg</span><span class=o>/</span><span class=n>Int32</span>
</span></span><span class=line><span class=cl><span class=n>std_msgs</span><span class=o>/</span><span class=n>msg</span><span class=o>/</span><span class=n>Int64</span>
</span></span><span class=line><span class=cl><span class=n>std_msgs</span><span class=o>/</span><span class=n>msg</span><span class=o>/</span><span class=ne>String</span>
</span></span><span class=line><span class=cl><span class=n>std_msgs</span><span class=o>/</span><span class=n>msg</span><span class=o>/</span><span class=n>UInt8</span>
</span></span><span class=line><span class=cl><span class=n>std_msgs</span><span class=o>/</span><span class=n>msg</span><span class=o>/</span><span class=n>UInt16</span>
</span></span><span class=line><span class=cl><span class=n>std_msgs</span><span class=o>/</span><span class=n>msg</span><span class=o>/</span><span class=n>UInt32</span>
</span></span><span class=line><span class=cl><span class=n>std_msgs</span><span class=o>/</span><span class=n>msg</span><span class=o>/</span><span class=n>UInt64</span>
</span></span><span class=line><span class=cl><span class=n>std_srvs</span><span class=o>/</span><span class=n>srv</span><span class=o>/</span><span class=n>Empty</span>
</span></span><span class=line><span class=cl><span class=n>std_srvs</span><span class=o>/</span><span class=n>srv</span><span class=o>/</span><span class=n>SetBool</span>
</span></span><span class=line><span class=cl><span class=n>std_srvs</span><span class=o>/</span><span class=n>srv</span><span class=o>/</span><span class=n>Trigger</span>
</span></span><span class=line><span class=cl><span class=n>nav_msgs</span><span class=o>/</span><span class=n>msg</span><span class=o>/</span><span class=n>Odometry</span>
</span></span></code></pre></div></details></p><p>Ultimately, you will have to add the following environment variable, either modifying ROS&rsquo; <code>setup.bash</code> or your <code>.bashrc</code>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>export</span> <span class=nv>COPPELIASIM_ROOT_DIR</span><span class=o>=</span><span class=s2>&#34;&lt;your coppelia installation path&gt;&#34;</span>
</span></span></code></pre></div><p>Now we can proceed to compile and install the library</p><h3 id=compiling-libsimextros2>Compiling libsimExtROS2<a hidden class=anchor aria-hidden=true href=#compiling-libsimextros2>¶</a></h3><p>After downloading everything, we can install it with <em>Colcon</em>, using the following command:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>colcon build --symlink-install
</span></span></code></pre></div><p>This will take lots of resources and will take up a while the first time, but don&rsquo;t worry, it will finish and install it.</p><h2 id=modifications-in-coppelia>Modifications in Coppelia<a hidden class=anchor aria-hidden=true href=#modifications-in-coppelia>¶</a></h2><h3 id=publishing-the-simulation-time>Publishing the simulation time<a hidden class=anchor aria-hidden=true href=#publishing-the-simulation-time>¶</a></h3><p>We can&rsquo;t use a &ldquo;wall clock&rdquo; because the simulation is not in real-time. Let&rsquo;s imagine
you implement an odometry module, and you try to calculate your speed by subtracting
your current position from a previous position and dividing by the number of seconds
elapsed. This formula will be wrong if your simulation is a bit slow, or if it is too fast.
That&rsquo;s why we need to publish Coppelia&rsquo;s simulation time into the topic <code>/clock</code>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-lua data-lang=lua><span class=line><span class=cl><span class=kr>function</span> <span class=nf>sysCall_init</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=p>...</span>
</span></span><span class=line><span class=cl>  <span class=n>simTimePub</span><span class=o>=</span><span class=n>simROS2.createPublisher</span><span class=p>(</span><span class=s1>&#39;/clock&#39;</span><span class=p>,</span><span class=s1>&#39;rosgraph_msgs/msg/Clock&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>...</span>
</span></span><span class=line><span class=cl><span class=kr>end</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>function</span> <span class=nf>sysCall_actuation</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=p>...</span>
</span></span><span class=line><span class=cl>  <span class=n>t</span><span class=o>=</span><span class=n>sim.getSimulationTime</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=n>simROS2.publish</span><span class=p>(</span><span class=n>simTimePub</span><span class=p>,</span> <span class=p>{</span><span class=n>clock</span><span class=o>=</span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>sec</span><span class=o>=</span><span class=n>math.floor</span><span class=p>(</span><span class=n>t</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=n>nanosec</span><span class=o>=</span><span class=p>(</span><span class=n>t</span><span class=o>-</span><span class=n>math.floor</span><span class=p>(</span><span class=n>t</span><span class=p>))</span><span class=o>*</span><span class=mi>10</span><span class=o>^</span><span class=mi>9</span><span class=p>}}</span>
</span></span><span class=line><span class=cl>  <span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>...</span>
</span></span><span class=line><span class=cl><span class=kr>end</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>function</span> <span class=nf>sysCall_cleanup</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=p>...</span>
</span></span><span class=line><span class=cl>  <span class=n>simROS2.shutdownPublisher</span><span class=p>(</span><span class=n>simTimePub</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>...</span>
</span></span><span class=line><span class=cl><span class=kr>end</span>
</span></span></code></pre></div><h3 id=publishing-transforms>Publishing transforms<a hidden class=anchor aria-hidden=true href=#publishing-transforms>¶</a></h3><p>The transforms allow ROS modules to calculate the exact distance between any two objects, publishing just the partial distances. For example, we can publish the distance of the laser&rsquo;s reference frame to the robot, and ROS can able to calculate the distance from the laser to anything automatically.</p><p><img loading=lazy src=https://navigation.ros.org/_images/simple_robot.png alt="Image of the robot transforms"></p><p><img loading=lazy src=https://navigation.ros.org/_images/tf_robot.png alt="Another sample image of how the transforms work"></p><p>Each published transform has a parent, and the <em>root</em> of this hierarchy is the transform that is not published (it is just referenced as a parent). According to the standard <a href=https://www.ros.org/reps/rep-0105.html>REP105</a>, this root should be <code>world</code> or <code>map</code> if we have just one robot.</p><p>We will publish the following transforms:</p><ul><li>From the lidar frame to the robot frame</li><li>From the robot to the odometry frame</li><li>From the wheels to the robot frame (needed to display the robot in the simulator)</li></ul><p>The final transform, from the odometry frame to the world map is published by another module, so we won&rsquo;t send it from Coppelia.</p><p>To publish all these transforms, we use the following code (remember to change the constants as needed):</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-lua data-lang=lua><span class=line><span class=cl><span class=kr>function</span> <span class=nf>getTransformStamped</span><span class=p>(</span><span class=n>objHandle</span><span class=p>,</span><span class=n>name</span><span class=p>,</span><span class=n>relTo</span><span class=p>,</span><span class=n>relToName</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=n>p</span><span class=o>=</span><span class=n>sim.getObjectPosition</span><span class=p>(</span><span class=n>objHandle</span><span class=p>,</span><span class=n>relTo</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=n>o</span><span class=o>=</span><span class=n>sim.getObjectQuaternion</span><span class=p>(</span><span class=n>objHandle</span><span class=p>,</span><span class=n>relTo</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=kr>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>header</span><span class=o>=</span><span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>stamp</span><span class=o>=</span><span class=n>simROS2.getSimulationTime</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>      <span class=n>frame_id</span><span class=o>=</span><span class=n>relToName</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=n>child_frame_id</span><span class=o>=</span><span class=n>name</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>transform</span><span class=o>=</span><span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>translation</span><span class=o>=</span><span class=p>{</span><span class=n>x</span><span class=o>=</span><span class=n>p</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span><span class=n>y</span><span class=o>=</span><span class=n>p</span><span class=p>[</span><span class=mi>2</span><span class=p>],</span><span class=n>z</span><span class=o>=</span><span class=n>p</span><span class=p>[</span><span class=mi>3</span><span class=p>]},</span>
</span></span><span class=line><span class=cl>      <span class=n>rotation</span><span class=o>=</span><span class=p>{</span><span class=n>x</span><span class=o>=</span><span class=n>o</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span><span class=n>y</span><span class=o>=</span><span class=n>o</span><span class=p>[</span><span class=mi>2</span><span class=p>],</span><span class=n>z</span><span class=o>=</span><span class=n>o</span><span class=p>[</span><span class=mi>3</span><span class=p>],</span><span class=n>w</span><span class=o>=</span><span class=n>o</span><span class=p>[</span><span class=mi>4</span><span class=p>]}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kr>end</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>function</span> <span class=nf>sysCall_actuation</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=p>...</span>
</span></span><span class=line><span class=cl>  <span class=n>simROS2.sendTransforms</span><span class=p>({</span>
</span></span><span class=line><span class=cl>    <span class=n>getTransformStamped</span><span class=p>(</span><span class=n>robotHandle</span><span class=p>,</span> <span class=n>ROBOT_FRAME_ID</span><span class=p>,</span> <span class=o>-</span><span class=mi>1</span><span class=p>,</span> <span class=n>PODOM_FRAME_ID</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=n>getTransformStamped</span><span class=p>(</span><span class=n>leftWheel</span><span class=p>,</span> <span class=s1>&#39;Pioneer_p3dx_leftWheel&#39;</span><span class=p>,</span> <span class=n>robotHandle</span><span class=p>,</span> <span class=n>ROBOT_FRAME_ID</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=n>getTransformStamped</span><span class=p>(</span><span class=n>rightWheel</span><span class=p>,</span> <span class=s1>&#39;Pioneer_p3dx_rightWheel&#39;</span><span class=p>,</span> <span class=n>robotHandle</span><span class=p>,</span><span class=n>ROBOT_FRAME_ID</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=n>getTransformStamped</span><span class=p>(</span><span class=n>caster_link</span><span class=p>,</span> <span class=s1>&#39;Pioneer_p3dx_caster_link&#39;</span><span class=p>,</span> <span class=n>robotHandle</span><span class=p>,</span> <span class=n>ROBOT_FRAME_ID</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=n>getTransformStamped</span><span class=p>(</span><span class=n>caster_wheel</span><span class=p>,</span> <span class=s1>&#39;Pioneer_p3dx_caster_wheel&#39;</span><span class=p>,</span> <span class=n>caster_link</span><span class=p>,</span> <span class=s1>&#39;Pioneer_p3dx_caster_link&#39;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=n>getTransformStamped</span><span class=p>(</span><span class=n>sensorRefHandle</span><span class=p>,</span> <span class=n>SENSOR_REF_FRAME</span><span class=p>,</span> <span class=n>robotHandle</span><span class=p>,</span> <span class=n>ROBOT_FRAME_ID</span><span class=p>),</span>
</span></span><span class=line><span class=cl>  <span class=p>})</span>
</span></span><span class=line><span class=cl>  <span class=p>...</span>
</span></span><span class=line><span class=cl><span class=kr>end</span>
</span></span></code></pre></div><h3 id=publishing-lidar-pointcloud>Publishing Lidar PointCloud<a hidden class=anchor aria-hidden=true href=#publishing-lidar-pointcloud>¶</a></h3><p>The lidar we used returns a PointCloud in Coppelia&rsquo;s signal <code>Pioneer_p3dx_lidar_data</code>. This PointCloud is an array of triplets of floats, each triplet representing the x, y and z coordinates of each point. We want to publish this data in a topic of type <a href=https://docs.ros2.org/foxy/api/sensor_msgs/msg/PointCloud2.html><code>sensor_msgs/msg/PointCloud2</code></a>.</p><p>This message needs us to send a stream of binary data and specify the type of this data in the parameter <code>fields</code>. We will see exactly how with the following commented code:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-lua data-lang=lua><span class=line><span class=cl><span class=kr>function</span> <span class=nf>sysCall_init</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=p>...</span>
</span></span><span class=line><span class=cl>  <span class=n>lidarDataTopicName</span> <span class=o>=</span> <span class=s1>&#39;/lidarPC&#39;</span>
</span></span><span class=line><span class=cl>  <span class=n>lidarDataPub</span><span class=o>=</span><span class=n>simROS2.createPublisher</span><span class=p>(</span><span class=n>lidarDataTopicName</span><span class=p>,</span> <span class=s1>&#39;sensor_msgs/msg/PointCloud2&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>...</span>
</span></span><span class=line><span class=cl><span class=kr>end</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>function</span> <span class=nf>sysCall_actuation</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=p>...</span>
</span></span><span class=line><span class=cl>  <span class=n>lidar_signal</span> <span class=o>=</span> <span class=s1>&#39;Pioneer_p3dx_lidar_data&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>-- Get binary data from signal</span>
</span></span><span class=line><span class=cl>  <span class=n>data</span> <span class=o>=</span> <span class=n>sim.getStringSignal</span><span class=p>(</span><span class=n>lidar_signal</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kr>if</span> <span class=p>(</span><span class=n>data</span> <span class=o>==</span> <span class=kc>nil</span> <span class=ow>or</span> <span class=o>#</span><span class=n>data</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=kr>then</span>
</span></span><span class=line><span class=cl>    <span class=c1>-- It&#39;s normal for this to happend in the first iteration of simulation</span>
</span></span><span class=line><span class=cl>    <span class=n>sim.addLog</span><span class=p>(</span><span class=n>sim.verbosity_scripterrors</span><span class=p>,</span> <span class=s1>&#39;signal name &#39;</span> <span class=o>..</span> <span class=n>lidar_signal</span> <span class=o>..</span> <span class=s1>&#39;, returned nil value&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=kr>else</span>
</span></span><span class=line><span class=cl>    <span class=c1>-- Unpack binary data as array of floats</span>
</span></span><span class=line><span class=cl>    <span class=n>floats</span> <span class=o>=</span> <span class=n>sim.unpackFloatTable</span><span class=p>(</span><span class=n>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>-- Each point is 3 floats, so the number of points</span>
</span></span><span class=line><span class=cl>    <span class=c1>-- is number of floats / 3</span>
</span></span><span class=line><span class=cl>    <span class=n>n</span> <span class=o>=</span> <span class=o>#</span><span class=n>floats</span><span class=o>//</span><span class=mi>3</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>simROS2.publish</span><span class=p>(</span><span class=n>lidarDataPub</span><span class=p>,</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>header</span><span class=o>=</span><span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>stamp</span><span class=o>=</span><span class=n>simROS2.getSimulationTime</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>        <span class=n>frame_id</span><span class=o>=</span><span class=s1>&#39;lidar_ref_frame&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=p>},</span>
</span></span><span class=line><span class=cl>      <span class=n>height</span><span class=o>=</span><span class=mi>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=c1>-- Number of points (not bytes)</span>
</span></span><span class=line><span class=cl>      <span class=n>width</span><span class=o>=</span><span class=n>n</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=c1>-- Each point is 3*4 = 12 bytes</span>
</span></span><span class=line><span class=cl>      <span class=n>point_step</span><span class=o>=</span><span class=mi>12</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=n>fields</span><span class=o>=</span><span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>-- datatype 7 is FLOAT32</span>
</span></span><span class=line><span class=cl>        <span class=c1>-- the offset is in BYTES</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span><span class=n>name</span><span class=o>=</span><span class=s1>&#39;x&#39;</span><span class=p>,</span> <span class=n>offset</span><span class=o>=</span><span class=mi>0</span><span class=p>,</span> <span class=n>datatype</span><span class=o>=</span><span class=mi>7</span><span class=p>,</span> <span class=n>count</span><span class=o>=</span><span class=mi>1</span><span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span><span class=n>name</span><span class=o>=</span><span class=s1>&#39;y&#39;</span><span class=p>,</span> <span class=n>offset</span><span class=o>=</span><span class=mi>4</span><span class=p>,</span> <span class=n>datatype</span><span class=o>=</span><span class=mi>7</span><span class=p>,</span> <span class=n>count</span><span class=o>=</span><span class=mi>1</span><span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span><span class=n>name</span><span class=o>=</span><span class=s1>&#39;z&#39;</span><span class=p>,</span> <span class=n>offset</span><span class=o>=</span><span class=mi>8</span><span class=p>,</span> <span class=n>datatype</span><span class=o>=</span><span class=mi>7</span><span class=p>,</span> <span class=n>count</span><span class=o>=</span><span class=mi>1</span><span class=p>},</span>
</span></span><span class=line><span class=cl>      <span class=p>},</span>
</span></span><span class=line><span class=cl>      <span class=c1>-- Unpack data as bytes (uint8)</span>
</span></span><span class=line><span class=cl>      <span class=n>data</span><span class=o>=</span><span class=n>sim.unpackUInt8Table</span><span class=p>(</span><span class=n>data</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>  <span class=kr>end</span>
</span></span><span class=line><span class=cl>  <span class=p>...</span>
</span></span><span class=line><span class=cl><span class=kr>end</span>
</span></span></code></pre></div><p>After all of this, the PointCloud message will be available on the topic <code>/lidarPC</code></p><h3 id=setting-the-robots-speed>Setting the robot&rsquo;s speed<a hidden class=anchor aria-hidden=true href=#setting-the-robots-speed>¶</a></h3><p>In this case, instead of a publisher, we will need to create a subscriber that receives
a message of type <em>Twist</em>. This message contains the desired linear and angular velocities.</p><p>We need to convert this to the angular velocity of the motors of the wheels, so, after applying some basic arithmetics, we get the following code:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-lua data-lang=lua><span class=line><span class=cl><span class=kr>function</span> <span class=nf>sysCall_init</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=p>...</span>
</span></span><span class=line><span class=cl>  <span class=n>velSub</span> <span class=o>=</span> <span class=n>simROS2.createSubscription</span><span class=p>(</span><span class=s1>&#39;/cmd_vel&#39;</span><span class=p>,</span> <span class=s1>&#39;geometry_msgs/msg/Twist&#39;</span><span class=p>,</span> <span class=s1>&#39;setVelocity_cb&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>...</span>
</span></span><span class=line><span class=cl><span class=kr>end</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>function</span> <span class=nf>setVelocity_cb</span><span class=p>(</span><span class=n>msg</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=c1>-- The message provides linear velocity in m/s</span>
</span></span><span class=line><span class=cl>  <span class=c1>-- but coppelia receives it in rad/s, we need to convert it</span>
</span></span><span class=line><span class=cl>  <span class=n>linear</span> <span class=o>=</span> <span class=n>msg.linear</span><span class=p>.</span><span class=n>x</span>
</span></span><span class=line><span class=cl>  <span class=n>angular</span> <span class=o>=</span> <span class=n>msg.angular</span><span class=p>.</span><span class=n>z</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>-- https://www.inf.ufrgs.br/~prestes/Courses/Robotics/manual_pioneer.pdf</span>
</span></span><span class=line><span class=cl>  <span class=n>wheel_radius</span> <span class=o>=</span> <span class=mf>0.195</span> <span class=o>/</span> <span class=mi>2</span> <span class=c1>-- 19.5 cmm</span>
</span></span><span class=line><span class=cl>  <span class=n>robot_width</span> <span class=o>=</span> <span class=mf>0.33</span> <span class=c1>-- 38 cm minus wheel width</span>
</span></span><span class=line><span class=cl>  <span class=n>vl</span> <span class=o>=</span> <span class=n>linear</span> <span class=o>-</span> <span class=p>(</span><span class=n>angular</span> <span class=o>*</span> <span class=n>robot_width</span><span class=p>)</span> <span class=o>/</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl>  <span class=n>vr</span> <span class=o>=</span> <span class=n>linear</span> <span class=o>+</span> <span class=p>(</span><span class=n>angular</span> <span class=o>*</span> <span class=n>robot_width</span><span class=p>)</span> <span class=o>/</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>sim.setJointTargetVelocity</span><span class=p>(</span><span class=n>leftMotor</span><span class=p>,</span> <span class=n>vl</span> <span class=o>/</span> <span class=n>wheel_radius</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=n>sim.setJointTargetVelocity</span><span class=p>(</span><span class=n>rightMotor</span><span class=p>,</span> <span class=n>vr</span> <span class=o>/</span> <span class=n>wheel_radius</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=kr>end</span>
</span></span></code></pre></div><h2 id=ros2>ROS2<a hidden class=anchor aria-hidden=true href=#ros2>¶</a></h2><p>The main advantage of using ROS2 instead of programming the behavior of our robot
directly on Coppelia is that ROS2 is platform agnostic and we can use it with any simulator, and even with a real robot.</p><p>The system has just 3 nodes:</p><ul><li><a href=https://github.com/ros-perception/pointcloud_to_laserscan><code>pointcloud_to_laserscan</code></a>: It transforms the data from type <em>Pointcloud2</em> to <em>LaserScan</em> so Slam Toolbox is able to use it.</li><li><a href=https://github.com/SteveMacenski/slam_toolbox><code>async_toolbox_node</code></a>: Makes a map and localizes the robot in the map.</li><li><a href=https://github.com/ros2/teleop_twist_keyboard><code>teleop_twist_keyboard</code></a>: Allows us to move the robot</li></ul><p>You&rsquo;ll need to install them before proceeding</p><h3 id=running-the-nodes>Running the nodes<a hidden class=anchor aria-hidden=true href=#running-the-nodes>¶</a></h3><p>The easiest way by far is to open three terminals and run the command to start the
node in each one. The order doesn&rsquo;t really matter as nodes usually wait for the info
to become available.</p><blockquote><p>Remember to source the ROS <code>setup.bash</code> file to make the <code>ros2</code> command available!</p></blockquote><p><details><summary markdown=span>Starting <code>pointcloud_to_laserscan</code></summary><p>We&rsquo;ll use the following bash command</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>ros2 run pointcloud_to_laserscan pointcloud_to_laserscan_node --ros-args <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  -p use_sim_time:<span class=o>=</span><span class=nb>true</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --remap cloud_in:<span class=o>=</span>/lidarPC
</span></span></code></pre></div><p>This will create a new topic called <code>/scan</code> with the data converted.</p></details></p><p><details><summary markdown=span>Starting <code>async_toolbox_node</code></summary><p>We need to specify the name of the frames (remember to change the name of the frames if you changed them)</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>ros2 run slam_toolbox async_slam_toolbox_ndoe --ros-args <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  -p base_frame:<span class=o>=</span><span class=s2>&#34;base_link&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  -p odom_frame:<span class=o>=</span><span class=s2>&#34;odom&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  -p map_frame:<span class=o>=</span><span class=s2>&#34;map&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  -p scan_topic:<span class=o>=</span><span class=s2>&#34;/scan&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  -p use_sim_time:<span class=o>=</span><span class=nb>true</span>
</span></span></code></pre></div><p>This will create a <code>/map</code> topic</p></details></p><p><details><summary markdown=span>Starting <code>teleop_twist_keyboard</code></summary><p>We don&rsquo;t need to modify anything, so the command is just</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>ros2 run teleop_twist_keyboard teleop_twist_keyboard
</span></span></code></pre></div><p>This will send the velocity commands via the <code>/cmd_vel</code> topic</p></details></p><h2 id=conclusion>Conclusion<a hidden class=anchor aria-hidden=true href=#conclusion>¶</a></h2><p>Finally, you can open rviz2 and start adding visualizations to visualize the map
that SLAM Toolbox created, you can also visualize the position and velocity of
the robot, and even the PointCloud and LaserScan!</p><p>Using the <code>teleop_twist_keyboard</code> you can move the robot around, and the map will change
in real-time. Pretty fun to drive. If you want, you can try with other nodes, or even
create your own to make the robot move autonomously.</p><p>If you have any doubts, feel free to leave a comment or <a href=https://github.com/daviddavo/blog.ddavo.me/issues>open an issue on GitHub</a>. If you already know a bit about robotics and you detect some mistake that I made, please tell me so and I&rsquo;ll modify the post. Thank you for reading me and see you next time!</p><h2 id=sources-and-more-information>Sources and more information<a hidden class=anchor aria-hidden=true href=#sources-and-more-information>¶</a></h2><ul><li><a href=https://wiki.archlinux.org/title/ROS>ArchWiki - ROS</a>. On how to install ROS and solve problems in ArchLinux / Manjaro.</li><li><a href=https://www.coppeliarobotics.com/helpFiles/en/ros2Interface.htm>CoppeliaSim User Manual</a>. One of these things that is not on google, but solves a lot of problems.</li><li><a href=https://github.com/CoppeliaRobotics/simExtROS2>GitHub - coppeliaRobotics/simExtROS2</a>. In the &ldquo;Issues&rdquo; part there are some interesting problems and solutions.</li><li><a href=https://navigation.ros.org/setup_guides/transformation/setup_transforms.html>ROS Planning. Setting Up Transformations</a>. NAV2 documentation is overall a good source material to understand how ROS works.</li><li><a href=https://www.ros.org/reps/rep-0105.html>REP 105 &ndash; Coordinate Frames for Mobile Platforms</a></li></ul></div><footer class=post-footer><div class=author-bio id=author-ddavo><img class=author-photo src=https://ddavo.me/images/perfil_huba47176c86c69447ba79fdf42134ec50_849216_200x200_fit_box_3.png alt><div class=author-social><a href=https://www.linkedin.com/in/ddavo/ target=_blank><svg aria-hidden="true" class="hi-svg-inline" fill="currentcolor" height="1em" viewBox="0 0 448 512" width="1em"><path d="M416 32H31.9C14.3 32 0 46.5.0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6.0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3.0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2.0 38.5 17.3 38.5 38.5.0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6.0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2.0 79.7 44.3 79.7 101.9V416z"/></svg>
</a><a href=https://github.com/daviddavo target=_blank><svg aria-hidden="true" class="hi-svg-inline" fill="currentcolor" height="1em" viewBox="0 0 496 512" width="1em"><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6.0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6.0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3.0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1.0-6.2-.3-40.4-.3-61.4.0.0-70 15-84.7-29.8.0.0-11.4-29.1-27.8-36.6.0.0-22.9-15.7 1.6-15.4.0.0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5.0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9.0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4.0 33.7-.3 75.4-.3 83.6.0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6.0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9.0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
</a><a href=https://stackoverflow.com/users/4505998/david-dav%c3%b3 target=_blank><svg aria-hidden="true" class="hi-svg-inline" fill="currentcolor" height="1em" viewBox="0 0 384 512" width="1em"><path d="M290.7 311 95 269.7 86.8 309l195.7 41zm51-87L188.2 95.7l-25.5 30.8 153.5 128.3zm-31.2 39.7L129.2 179l-16.7 36.5L293.7 3e2zM262 32l-32 24 119.3 160.3 32-24zm20.5 328h-2e2v39.7h2e2zm39.7 80H42.7V320h-40v160h359.5V320h-40z"/></svg>
</a><a href=https://www.kaggle.com/daviddavo target=_blank><svg aria-hidden="true" class="hi-svg-inline" fill="currentcolor" height="1em" viewBox="0 0 320 512" width="1em"><path d="M304.2 501.5 158.4 320.3 298.2 185c2.6-2.7 1.7-10.5-5.3-10.5h-69.2c-3.5.0-7 1.8-10.5 5.3L80.9 313.5V7.5q0-7.5-7.5-7.5H21.5Q14 0 14 7.5v497q0 7.5 7.5 7.5h51.9q7.5.0 7.5-7.5v-109l30.8-29.3 110.5 140.6c3 3.5 6.5 5.3 10.5 5.3h66.9q5.25.0 6-3z"/></svg>
</a><a href=https://orcid.org/0000-0003-1744-8314 target=_blank><svg aria-hidden="true" class="hi-svg-inline" fill="currentcolor" height="1em" viewBox="0 0 512 512" width="1em"><path d="M294.75 188.19h-45.92V342h47.47c67.62.0 83.12-51.34 83.12-76.91.0-41.64-26.54-76.9-84.67-76.9zM256 8C119 8 8 119 8 256s111 248 248 248 248-111 248-248S393 8 256 8zm-80.79 360.76h-29.84v-207.5h29.84zm-14.92-231.14a19.57 19.57.0 1119.57-19.57 19.64 19.64.0 01-19.57 19.57zM3e2 369h-81V161.26h80.6c76.73.0 110.44 54.83 110.44 103.85C410 318.39 368.38 369 3e2 369z"/></svg>
</a><a href="https://scholar.google.com/citations?user=LNSSvv4AAAAJ" target=_blank><svg aria-hidden="true" class="hi-svg-inline" fill="currentcolor" height="1em" viewBox="0 0 512 512" width="1em"><path d="M390.9 298.5s0 .1.1.1c9.2 19.4 14.4 41.1 14.4 64C405.3 445.1 338.5 512 256 512s-149.3-66.9-149.3-149.3c0-22.9 5.2-44.6 14.4-64h0c1.7-3.6 3.6-7.2 5.6-10.7 4.4-7.6 9.4-14.7 15-21.3 27.4-32.6 68.5-53.3 114.4-53.3 33.6.0 64.6 11.1 89.6 29.9 9.1 6.9 17.4 14.7 24.8 23.5 5.6 6.6 10.6 13.8 15 21.3 2 3.4 3.8 7 5.5 10.5zm26.4-18.8c-30.1-58.4-91-98.4-161.3-98.4s-131.2 40-161.3 98.4L0 202.7 256 0 512 202.7l-94.7 77.1z"/></svg></a></div><div class=author-details><div class=author-name>About David Davó</div><div class=author-occupation>Research Assistant @ Complutense University of Madrid</div><div class=author-contact><a href=https://ddavo.me target=_blank><svg aria-hidden="true" class="hi-svg-inline" fill="none" height="1em" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="1em"><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
ddavo.me
</a><a href=mailto:david@ddavo.me><svg aria-hidden="true" class="hi-svg-inline" fill="none" height="1em" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="1em"><path d="M4 4h16c1.1.0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1.0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>
david@ddavo.me</a></div><div class=author-description><p>Research assistant that just finished its Master’s in Artificial Intelligence at the Politechnic University of Madrid.
Researching about online communities in blockchain at the Complutense University of Madrid since 2021. In 2022 I received the BsC in Computer Science at that same university, and in 2024 a MsC in Artificial Intelligence at the Politechnic University of Madrid.</p></div></div></div></footer><div class=comments-separator></div><script type=text/javascript src=https://latest.cactus.chat/cactus.js></script><link rel=stylesheet href=https://latest.cactus.chat/style.css type=text/css><div id=comment-section></div><script>initComments({node:document.getElementById("comment-section"),defaultHomeserverUrl:"https://matrix.cactus.chat:8448",serverName:"cactus.chat",siteName:"blog.ddavo.me",commentSectionId:"/posts/tutorials/ros2-coppelia-lidar/"})</script></article></main><footer class=footer><span>© David Davó 2015 - 2024</span><span style=display:inline-block;margin-left:1em>
<a href=https://creativecommons.org/licenses/by-sa/4.0/>CC BY-SA</a>
</span><span style=display:inline-block;margin-left:1em>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
    <a href=https://github.com/reorx/hugo-PaperModX/ rel=noopener target=_blank>PaperModX</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>(function(){const t=""=="1";if(t)return;let e=document.getElementById("theme-toggle");e.removeEventListener("click",toggleThemeListener),e.addEventListener("click",toggleThemeListener)})()</script><script>(function(){let e=document.getElementById("menu");e&&(e.scrollLeft=localStorage.getItem("menu-scroll-position"),e.onscroll=function(){localStorage.setItem("menu-scroll-position",e.scrollLeft)});const t=""=="1",n=""=="1";if(window.matchMedia("(prefers-reduced-motion: reduce)").matches||t||n)return;document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})})()</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>if(window.scrollListeners)for(const e of scrollListeners)window.removeEventListener("scroll",e);window.scrollListeners=[]</script><script src=/js/medium-zoom.min.js data-no-instant></script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerText="copy";function s(){t.innerText="copied!",setTimeout(()=>{t.innerText="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script><script>(function(){const a="1"=="1";if(!a)return;if(!document.querySelector(".toc")){console.log("no toc found, ignore toc scroll");return}const r=window.scrollListeners,t=document.querySelectorAll("h1[id],h2[id],h3[id],h4[id],h5[id]"),n="active";let e=t[0];o(e).classList.add(n);const c=()=>{const s=[];for(const e of t)if(l(e)<5)s.push(e);else break;s.length>0?newActiveHeading=s[s.length-1]:newActiveHeading=t[0],e!=newActiveHeading&&(o(e).classList.remove(n),e=newActiveHeading,o(e).classList.add(n))};let s=null;const i=()=>{s!==null&&clearTimeout(s),s=setTimeout(c,50)};window.addEventListener("scroll",i,!1),r.push(i);function o(e){const t=encodeURI(e.getAttribute("id")).toLowerCase();return document.querySelector(`.toc ul li a[href="#${t}"]`)}function l(e){if(!e.getClientRects().length)return 0;let t=e.getBoundingClientRect();return t.top}})()</script></body></html>