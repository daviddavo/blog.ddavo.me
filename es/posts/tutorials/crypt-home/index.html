<!doctype html><html lang=es dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Como encriptar tu home y desencriptarla automágicamente | David Davó's dev log</title><meta name=keywords content="tutorial,crypt,manjaro,archlinux"><meta name=description content="Alguna que otra vez toca llevar de paseo el portátil por las calles y el Metro de Madrid, con todos los riesgos que ello conlleva.
El portátil en sí no me da mucha pena, pero en el disco duro hay datos. Datos relevantes. Todos pensamos que no hemos hecho nada malo y que no tenemos nada que ocultar&mldr; &ndash;&#34;¿por qué iba a querer encriptar cosas si no soy de la mafia?"><meta name=author content="David Davó"><link rel=canonical href=https://blog.ddavo.me/es/posts/tutorials/crypt-home/><link crossorigin=anonymous href=/assets/css/stylesheet.min.e1a170e80df982e34adb7be7c9460499f7bcbfdb87f7b420ba5f66e8a84039f8.css integrity="sha256-4aFw6A35guNK23vnyUYEmfe8v9uH97Qgul9m6KhAOfg=" rel="preload stylesheet" as=style><link rel=icon href=https://blog.ddavo.me/favicon.ico><link rel=apple-touch-icon href=https://blog.ddavo.me/apple-touch-icon.png><link rel=alternate hreflang=es href=https://blog.ddavo.me/es/posts/tutorials/crypt-home/><meta name=twitter:title content="Como encriptar tu home y desencriptarla automágicamente | David Davó's dev log
"><meta name=twitter:description content="Alguna que otra vez toca llevar de paseo el portátil por las calles y el Metro de Madrid, con todos los riesgos que ello conlleva.
El portátil en sí no me da mucha pena, pero en el disco duro hay datos. Datos relevantes. Todos pensamos que no hemos hecho nada malo y que no tenemos nada que ocultar&mldr; &ndash;&#34;¿por qué iba a querer encriptar cosas si no soy de la mafia?"><meta property="og:title" content="Como encriptar tu home y desencriptarla automágicamente | David Davó's dev log
"><meta property="og:description" content="Alguna que otra vez toca llevar de paseo el portátil por las calles y el Metro de Madrid, con todos los riesgos que ello conlleva.
El portátil en sí no me da mucha pena, pero en el disco duro hay datos. Datos relevantes. Todos pensamos que no hemos hecho nada malo y que no tenemos nada que ocultar&mldr; &ndash;&#34;¿por qué iba a querer encriptar cosas si no soy de la mafia?"><meta property="og:type" content="article"><meta property="og:url" content="https://blog.ddavo.me/es/posts/tutorials/crypt-home/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-01-30T15:38:09+00:00"><meta property="article:modified_time" content="2022-01-31T21:10:15+00:00"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://blog.ddavo.me/es/posts/"},{"@type":"ListItem","position":2,"name":"Como encriptar tu home y desencriptarla automágicamente","item":"https://blog.ddavo.me/es/posts/tutorials/crypt-home/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Como encriptar tu home y desencriptarla automágicamente | David Davó's dev log\n","name":"Como encriptar tu home y desencriptarla automágicamente","description":"Alguna que otra vez toca llevar de paseo el portátil por las calles y el Metro de Madrid, con todos los riesgos que ello conlleva.\nEl portátil en sí no me da mucha pena, pero en el disco duro hay datos. Datos relevantes. Todos pensamos que no hemos hecho nada malo y que no tenemos nada que ocultar\u0026hellip; \u0026ndash;\u0026quot;¿por qué iba a querer encriptar cosas si no soy de la mafia?","keywords":["tutorial","crypt","manjaro","archlinux"],"wordCount":"590","inLanguage":"es","datePublished":"2022-01-30T15:38:09.185Z","dateModified":"2022-01-31T21:10:15.725Z","author":{"@type":"Person","name":"David Davó"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.ddavo.me/es/posts/tutorials/crypt-home/"},"publisher":{"@type":"Organization","name":"David Davó's dev log\n","logo":{"@type":"ImageObject","url":"https://blog.ddavo.me/favicon.ico"}}}</script><script>var _paq=window._paq=window._paq||[];_paq.push(["trackPageView"]),_paq.push(["enableLinkTracking"]),function(){e="//matomo.ddavo.me/",_paq.push(["setTrackerUrl",e+"matomo.php"]),_paq.push(["setSiteId","4"]);var e,n=document,t=n.createElement("script"),s=n.getElementsByTagName("script")[0];t.async=!0,t.src=e+"matomo.js",s.parentNode.insertBefore(t,s)}()</script><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary-bg:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list-page{background:var(--theme)}.list-page:not(.dark)::-webkit-scrollbar-track{background:0 0}.list-page:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript></head><body class="type-posts kind-page layout-" id=top><script data-no-instant>function switchTheme(e){switch(e){case"light":document.body.classList.remove("dark");break;case"dark":document.body.classList.add("dark");break;default:window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")}}function isDarkTheme(){return document.body.className.includes("dark")}function getPrefTheme(){return localStorage.getItem("pref-theme")}function setPrefTheme(e){switchTheme(e),localStorage.setItem("pref-theme",e)}const toggleThemeCallbacks={};toggleThemeCallbacks.main=e=>{setPrefTheme(e?"light":"dark")},window.addEventListener("toggle-theme",function(){const e=isDarkTheme();for(const t in toggleThemeCallbacks)toggleThemeCallbacks[t](e)});function toggleThemeListener(){window.dispatchEvent(new CustomEvent("toggle-theme"))}</script><script>(function(){const t="light",e=getPrefTheme(),n=e||t;switchTheme(n)})()</script><header class=header><nav class=nav><div class=logo><a href=https://blog.ddavo.me/ accesskey=h title="David Davó's dev log
 (Alt + H)">David Davó's dev log</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button><ul class=lang-switch><li>|</li><li><a href=https://blog.ddavo.me/ title="🇬🇧 English" aria-label=":uk: English">🇬🇧 English</a></li></ul></span></div><ul id=menu></ul></nav></header><main class="main post"><article class=post-single><header class=post-header><h1 class=post-title>Como encriptar tu home y desencriptarla automágicamente</h1><div class=post-meta><span class=meta-item><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar" style="user-select:text"><rect x="3" y="4" width="18" height="18" rx="2" ry="2" style="user-select:text"/><line x1="16" y1="2" x2="16" y2="6" style="user-select:text"/><line x1="8" y1="2" x2="8" y2="6" style="user-select:text"/><line x1="3" y1="10" x2="21" y2="10" style="user-select:text"/></svg><span>2022-01-30</span></span><span class=meta-item><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon" style="user-select:text"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z" style="user-select:text"/><line x1="7" y1="7" x2="7" y2="7" style="user-select:text"/></svg>
<span class=post-tags><a href=https://blog.ddavo.me/es/tags/tutorial/>tutorial</a><a href=https://blog.ddavo.me/es/tags/crypt/>crypt</a><a href=https://blog.ddavo.me/es/tags/manjaro/>manjaro</a><a href=https://blog.ddavo.me/es/tags/archlinux/>archlinux</a></span></span><span class=meta-item><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text" style="user-select:text"><path d="M14 2H6A2 2 0 004 4v16a2 2 0 002 2h12a2 2 0 002-2V8z" style="user-select:text"/><polyline points="14 2 14 8 20 8" style="user-select:text"/><line x1="16" y1="13" x2="8" y2="13" style="user-select:text"/><line x1="16" y1="17" x2="8" y2="17" style="user-select:text"/><polyline points="10 9 9 9 8 9" style="user-select:text"/></svg>
<span>590 palabras</span></span><span class=meta-item><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" stroke="currentcolor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<span>3 min</span></span></div></header><div class="toc side left"><details open><summary accesskey=c title="(Alt + C)"><span class=details>Tabla de Contenidos</span></summary><div class=inner><ul><li><a href=#migrando-el-home aria-label="Migrando el home">Migrando el <code>home</code></a></li><li><a href=#habilitando-el-automontaje aria-label="Habilitando el automontaje">Habilitando el automontaje</a></li><li><a href=#fuentes-y-m%c3%a1s-informaci%c3%b3n aria-label="Fuentes y más información">Fuentes y más información</a></li></ul></div></details></div><div class=post-content><p>Alguna que otra vez toca llevar de paseo el portátil por las calles y el Metro de Madrid, con todos los riesgos que ello conlleva.</p><p>El portátil en sí no me da mucha pena, pero en el disco duro hay datos. Datos relevantes.
Todos pensamos que no hemos hecho nada malo y que no tenemos nada que ocultar&mldr; &ndash;"¿por qué iba a
querer encriptar cosas si no soy de la mafia?"</p><p>Pero seguro que tienes una o dos copias de tus DNIs. Tanto caducados como vigentes. Y también tendrás
alguna factura con tu dirección de casa, y correos electrónicos con alguna contraseña, y papeles de la universidad/trabajo, y&mldr; Pues eso.</p><p></p><blockquote><p>El robo de identidad no es una broma, Jim!
&ndash; Dwight K. Schrute</p></blockquote><p>Por eso vamos a aprender a encriptar TODA tu carpeta home personal, con un método que funciona en Arch Linux y otras distros derivadas como Manjaro.</p><blockquote><p><strong>¡¡ANTES DE CONTINUAR!!</strong></p><p>Has de tener cuidado porque los datos encriptados, en caso de perder la clave o
la contraseña, no podrán ser recuperados de ninguna forma (o por lo menos, esa es la idea)</p></blockquote><h2 id=migrando-el-home>Migrando el <code>home</code><a hidden class=anchor aria-hidden=true href=#migrando-el-home>¶</a></h2><p>Es sencillo, simplemente debemos llamar, desde el usuario <code>root</code>, a un script que viene ya hecho y te configura todo él solito.
Eso sí, vas a necesitar más o menos 2.5 veces el espacio de tu carpeta <code>$HOME</code>, por lo que borra primero la caché y todo lo que
no te preocupe mucho borrar. Ese espacio extra podrá ser liberado después del proceso, así que en el peor de los casos puedes mover algunas cosas a otro disco duro, y luego volver a dejarlas donde estaban.</p><p>Antes de continuar, necesitarás asegurarte de que los siguientes comandos están instalados y funcionando:</p><ul><li><input disabled type=checkbox> <code>rsync</code></li><li><input disabled type=checkbox> <code>lsof</code></li><li><input disabled type=checkbox> <code>which</code></li></ul><p>Inicia sesión con el usuario root (<strong>no vale usar tu usuario con <code>sudo</code></strong>). Una vez hayas comprobado que los comandos funcionan, debemos cargar el módulo del kernel encargado de la encriptación, usando <code>modprobe</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>$ modprobe ecryptfs
</span></span></code></pre></div><p>Finalmente, antes de comenzar con la migración, asegurate de que ningún proceso del usuario del que quieres migrar está ejecutándose, pues podría dar problemas. Puedes usar <code>ps -U &lt;usuario></code> (si la lista está vacía, es que no hay ningún proceso siendo ejecutado por ese usuario). Ahora sí, tan sólo tienes que introducir el siguiente comando y seguir las instrucciones:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>$ ecryptfs-migrate-home -u &lt;usuario&gt;
</span></span></code></pre></div><p>Este comando te creará una &ldquo;copia de seguridad&rdquo; en <code>/home/&lt;usuario>.&lt;cadena></code>, que deberías borrar una vez todo funcione correctamente.</p><h2 id=habilitando-el-automontaje>Habilitando el automontaje<a hidden class=anchor aria-hidden=true href=#habilitando-el-automontaje>¶</a></h2><p>Para habilitar el automontaje, usaremos un &ldquo;módulo de autenticación conectable&rdquo; o PAM (<em>Pluggable Authentication Module</em>). Es básicamente una especie de plugin del sistema de inicio de sesión de Linux, que en este caso nos permitirá montar una carpeta cifrada mientras iniciamos sesión (pero antes de cargar nuestro entorno de escritorio y esas cosas).</p><p>Vamos a editar el archivo <code>/etc/pam.d/system-auth</code></p><hr><p><strong>Después</strong> de la línea <code>auth required pam_unix.so</code> (o <code>auth [default=die] pam_faillock.so authfail</code> si existe) inserta:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>auth [success=1 default=ignore] pam_succeed_if.so service = systemd-user quiet
</span></span><span class=line><span class=cl>auth required                   pam_ecryptfs.so unwrap
</span></span></code></pre></div><hr><p><strong>Sobre</strong> la línea <code>password required pam_unix.so</code> (o <code>-password [success=1 default=ignore] pam_systemd_home.so</code> si existe), añade:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>password    optional    pam_ecryptfs.so
</span></span></code></pre></div><hr><p>Para terminar, <strong>tras</strong> la linea <code>session required pam_unix.so</code> pon:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>session [success=1 default=ignore] pam_succeed_if.so service = systemd-user quiet
</span></span><span class=line><span class=cl>session optional                   pam_ecryptfs.so unwrap
</span></span></code></pre></div><p>Ahora ya puedes cerrar tu sesión de root e iniciar sesión con tu usuario normal.
Debería estar todo justo donde lo dejaste.</p><p>También puedes probar a iniciar sesión desde otro usuario (con tu sesión cerrada, claro), e intentar acceder a <code>/home/&lt;nombreusuarioprotegido></code>. ¿Que pasará?</p><h2 id=fuentes-y-más-información>Fuentes y más información<a hidden class=anchor aria-hidden=true href=#fuentes-y-más-información>¶</a></h2><ul><li><a href=https://wiki.archlinux.org/title/ECryptfs>eCryptfs - ArchWiki</a></li><li><a href=https://wiki.archlinux.org/title/PAM>PAM - ArchWiki</a></li><li><a href=https://wiki.archlinux.org/title/Pam_mount>pam_mount - ArchWiki</a></li></ul></div><footer class=post-footer></footer><div class=comments-separator></div><script type=text/javascript src=https://latest.cactus.chat/cactus.js></script>
<link rel=stylesheet href=https://latest.cactus.chat/style.css type=text/css><div id=comment-section></div><script>initComments({node:document.getElementById("comment-section"),defaultHomeserverUrl:"https://matrix.cactus.chat:8448",serverName:"cactus.chat",siteName:"blog.ddavo.me",commentSectionId:"/es/posts/tutorials/crypt-home/"})</script></article></main><footer class=footer><span>David Davó (c) 2021</span><span style=display:inline-block;margin-left:1em>
<a href=https://creativecommons.org/licenses/by-sa/4.0/>CC BY-SA</a></span>
<span style=display:inline-block;margin-left:1em>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
    <a href=https://github.com/reorx/hugo-PaperModX/ rel=noopener target=_blank>PaperModX</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>(function(){const t=""=="1";if(t)return;let e=document.getElementById("theme-toggle");e.removeEventListener("click",toggleThemeListener),e.addEventListener("click",toggleThemeListener)})()</script><script>(function(){let e=document.getElementById("menu");e&&(e.scrollLeft=localStorage.getItem("menu-scroll-position"),e.onscroll=function(){localStorage.setItem("menu-scroll-position",e.scrollLeft)});const t=""=="1",n=""=="1";if(window.matchMedia("(prefers-reduced-motion: reduce)").matches||t||n)return;document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})})()</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>if(window.scrollListeners)for(const e of scrollListeners)window.removeEventListener("scroll",e);window.scrollListeners=[]</script><script src=/js/medium-zoom.min.js data-no-instant></script>
<script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerText="copiar";function s(){t.innerText="¡copiado!",setTimeout(()=>{t.innerText="copiar"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script><script>(function(){const a="1"=="1";if(!a)return;if(!document.querySelector(".toc")){console.log("no toc found, ignore toc scroll");return}const r=window.scrollListeners,t=document.querySelectorAll("h1[id],h2[id],h3[id],h4[id],h5[id]"),n="active";let e=t[0];o(e).classList.add(n);const c=()=>{const s=[];for(const e of t)if(l(e)<5)s.push(e);else break;s.length>0?newActiveHeading=s[s.length-1]:newActiveHeading=t[0],e!=newActiveHeading&&(o(e).classList.remove(n),e=newActiveHeading,o(e).classList.add(n))};let s=null;const i=()=>{s!==null&&clearTimeout(s),s=setTimeout(c,50)};window.addEventListener("scroll",i,!1),r.push(i);function o(e){const t=encodeURI(e.getAttribute("id")).toLowerCase();return document.querySelector(`.toc ul li a[href="#${t}"]`)}function l(e){if(!e.getClientRects().length)return 0;let t=e.getBoundingClientRect();return t.top}})()</script></body></html>